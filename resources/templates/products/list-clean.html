<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<!-- Head con fragmento -->

<head th:replace="~{fragments/head :: head('Productos', '/css/products.css', '/js/products.js')}"></head>

<body>
	<!-- Navbar -->
	<div
		th:replace="~{fragments/navbar :: navbar('products', ${categories}, ${cartCount}, ${isAuthenticated}, ${username})}">
	</div>

	<div class="container-fluid mt-4 fade-in">
		<div class="row">
			<!-- Sidebar con filtros -->
			<div class="col-md-3">
				<div class="card filter-sidebar">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0"><i class="fas fa-filter"></i> Filtros</h5>
					</div>
					<div class="card-body">
						<!-- Formulario de filtros -->
						<form method="get" th:action="@{/web/products}" id="filterForm">
							<!-- Búsqueda -->
							<div class="mb-3">
								<label for="search" class="form-label">
									<i class="fas fa-search"></i> Buscar productos
								</label>
								<input type="text" class="form-control search-box" id="search" name="search"
									th:value="${searchTerm}" placeholder="Nombre del producto..." />
							</div>

							<!-- Filtro por categorías -->
							<div class="mb-3">
								<label class="form-label"> <i class="fas fa-tags"></i> Categorías </label>
								<div class="category-filter">
									<div class="form-check">
										<input class="form-check-input" type="radio" name="categoryId" id="allCategories" value=""
											th:checked="${selectedCategoryId == null}" />
										<label class="form-check-label fw-bold" for="allCategories">
											Todas las categorías
										</label>
									</div>
									<hr />
									<div class="form-check" th:each="category : ${categories}">
										<input class="form-check-input" type="radio" name="categoryId"
											th:id="'category' + ${category.id}" th:value="${category.id}"
											th:checked="${selectedCategoryId == category.id}" />
										<label class="form-check-label" th:for="'category' + ${category.id}"
											th:text="${category.name}">
										</label>
									</div>
								</div>
							</div>

						</form>
					</div>
				</div>
			</div>

			<!-- Contenido principal -->
			<div class="col-md-9">
				<!-- Header con información -->
				<div class="d-flex justify-content-between align-items-center mb-4">
					<div>
						<h2 class="text-primary">
							<i class="fas fa-box-open"></i>
							<span th:if="${selectedCategoryId != null and categories != null}">
								<span th:each="cat : ${categories}" th:if="${cat.id == selectedCategoryId}"
									th:text="${cat.name}"></span>
							</span>
							<span th:if="${selectedCategoryId == null}">Todos los productos</span>
						</h2>
						<p class="text-muted mb-0">
							<span th:text="${totalElements}">0</span> productos encontrados
							<span th:if="${searchTerm != null and !searchTerm.isEmpty()}">
								para "<strong th:text="${searchTerm}"></strong>"
							</span>
						</p>
					</div>

					<!-- Selector de cantidad por página -->
					<div class="dropdown">
						<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
							<i class="fas fa-list"></i> <span th:text="${pageSize}">12</span> por página
						</button>
						<ul class="dropdown-menu">
							<li>
								<a class="dropdown-item"
									th:href="@{/web/products(page=${currentPage}, size=6, categoryId=${categoryParam}, search=${searchParam})}">6
									por página</a>
							</li>
							<li>
								<a class="dropdown-item"
									th:href="@{/web/products(page=${currentPage}, size=12, categoryId=${categoryParam}, search=${searchParam})}">12
									por página</a>
							</li>
							<li>
								<a class="dropdown-item"
									th:href="@{/web/products(page=${currentPage}, size=24, categoryId=${categoryParam}, search=${searchParam})}">24
									por página</a>
							</li>
						</ul>
					</div>
				</div>

				<!-- Grid de productos -->
				<div class="row product-grid" th:if="${products != null and products.hasContent()}">
					<div class="col-md-4 col-lg-3 mb-4" th:each="product : ${products.content}">
						<div class="card product-card h-100 shadow-hover"
							th:classappend="${product.productCondition.name() == 'NEW'} ? 'product-new' : 
                                            (${product.productCondition.name() == 'LIKE_NEW'} ? 'product-like-new' : 
                                            (${product.productCondition.name() == 'REFURBISHED'} ? 'product-refurbished' : 'product-used'))">
							<!-- Imagen del producto -->
							<div class="position-relative">
								<img
									th:src="${product.detailProduct?.imageUrl != null ? product.detailProduct.imageUrl : '/images/no-image.png'}"
									class="card-img-top product-image" th:alt="${product.name}" />

								<!-- Badge de condición -->
								<span class="badge position-absolute top-0 start-0 m-2 product-badge"
									th:classappend="${product.productCondition.name() == 'NEW'} ? 'bg-success' : 
                                                     (${product.productCondition.name() == 'LIKE_NEW'} ? 'bg-info' : 
                                                     (${product.productCondition.name() == 'REFURBISHED'} ? 'bg-warning' : 'bg-secondary'))"
									th:text="${product.productCondition.name() == 'NEW'} ? 'Nuevo' : 
                                               (${product.productCondition.name() == 'LIKE_NEW'} ? 'Como nuevo' : 
                                               (${product.productCondition.name() == 'REFURBISHED'} ? 'Reacondicionado' : 'Usado'))">
								</span>

								<!-- Badge de stock bajo -->
								<span
									th:if="${product.inventory != null and product.inventory.currentStock <= 5 and product.inventory.currentStock > 0}"
									class="badge bg-danger position-absolute top-0 end-0 m-2 product-badge">
									¡Últimas <span th:text="${product.inventory.currentStock}">5</span>!
								</span>

								<!-- Badge sin stock -->
								<span th:if="${!product.hasStock()}"
									class="badge bg-dark position-absolute top-0 end-0 m-2 product-badge">
									Sin stock
								</span>
							</div>

							<div class="card-body d-flex flex-column">
								<!-- Nombre del producto -->
								<h6 class="card-title fw-bold" th:text="${product.name}">
									Nombre del producto
								</h6>

								<!-- Descripción -->
								<p class="card-text text-muted small flex-grow-1 text-truncate-3"
									th:text="${product.detailProduct?.description != null ? product.detailProduct.description : 'Sin descripción'}">
								</p>

								<!-- Información adicional -->
								<div class="mb-2">
									<small class="text-muted d-block">
										<i class="fas fa-barcode"></i> <span th:text="${product.code}">123456789</span>
									</small>
									<small class="text-muted d-block">
										<i class="fas fa-boxes"></i> Stock: <span th:text="${product.stock}">10</span>
									</small>
									<small class="text-muted" th:if="${product.detailProduct?.brand}">
										<i class="fas fa-tag"></i> <span th:text="${product.detailProduct.brand}">Marca</span>
									</small>
								</div>

								<!-- Precio -->
								<div class="mb-3" th:if="${product.detailProduct?.price}">
									<div th:if="${product.detailProduct.discount > 0}">
										<span class="original-price" th:text="'S/. ' + ${product.detailProduct.price}">S/.
											100.00</span>
										<div class="price"
											th:text="'S/. ' + ${#numbers.formatDecimal(product.detailProduct.price * (1 - product.detailProduct.discount / 100.0), 0, 2)}">
											S/. 80.00
										</div>
										<small class="text-success">
											<i class="fas fa-percent"></i> <span
												th:text="${product.detailProduct.discount}">20</span>%
											descuento
										</small>
									</div>
									<div th:if="${product.detailProduct.discount == 0}">
										<div class="price"
											th:text="'S/. ' + ${#numbers.formatDecimal(product.detailProduct.price, 0, 2)}">
											S/. 100.00
										</div>
									</div>
								</div>

								<!-- Botones -->
								<div class="mt-auto">
									<a th:href="@{/web/products/{id}(id=${product.id})}"
										class="btn btn-primary btn-sm w-100 mb-2">
										<i class="fas fa-eye"></i> Ver detalles
									</a>
									<button class="btn btn-outline-success btn-sm w-100 btn-add-to-cart"
										th:if="${product.hasStock()}" th:data-product-id="${product.id}">
										<i class="fas fa-cart-plus"></i> Agregar al carrito
									</button>
									<!-- <button class="btn btn-secondary btn-sm w-100" th:if="${!product.hasStock()}" disabled>
										<i class="fas fa-times"></i> Sin stock
									</button> -->
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Mensaje cuando no hay productos -->
				<div th:if="${products == null or !products.hasContent()}" class="text-center py-5">
					<i class="fas fa-search fa-3x text-muted mb-3"></i>
					<h4>No se encontraron productos</h4>
					<p class="text-muted">
						<span th:if="${searchTerm != null and !searchTerm.isEmpty()}">
							No hay productos que coincidan con "<strong th:text="${searchTerm}"></strong>"
						</span>
						<span th:if="${searchTerm == null or searchTerm.isEmpty()}">
							No hay productos disponibles en esta categoría
						</span>
					</p>
				</div>

				<!-- Paginación -->
				<nav th:if="${products != null and products.hasContent() and totalPages > 1}" class="mt-4">
					<ul class="pagination justify-content-center">
						<!-- Anterior -->
						<li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
							<a class="page-link"
								th:href="@{/web/products(page=${currentPage - 1}, size=${pageSize}, categoryId=${categoryParam}, search=${searchParam})}"
								th:if="${currentPage > 0}">
								<i class="fas fa-chevron-left"></i> Anterior
							</a>
							<span class="page-link" th:if="${currentPage == 0}">
								<i class="fas fa-chevron-left"></i> Anterior
							</span>
						</li>

						<!-- Números de página -->
						<li class="page-item" th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
							th:if="${pageNum >= currentPage - 2 and pageNum <= currentPage + 2}"
							th:classappend="${pageNum == currentPage} ? 'active'">
							<a class="page-link"
								th:href="@{/web/products(page=${pageNum}, size=${pageSize}, categoryId=${categoryParam}, search=${searchParam})}"
								th:text="${pageNum + 1}">1</a>
						</li>

						<!-- Siguiente -->
						<li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
							<a class="page-link"
								th:href="@{/web/products(page=${currentPage + 1}, size=${pageSize}, categoryId=${categoryParam}, search=${searchParam})}"
								th:if="${currentPage < totalPages - 1}">
								Siguiente <i class="fas fa-chevron-right"></i>
							</a>
							<span class="page-link" th:if="${currentPage >= totalPages - 1}">
								Siguiente <i class="fas fa-chevron-right"></i>
							</span>
						</li>
					</ul>
				</nav>
			</div>
		</div>
	</div>

	<!-- Modal de confirmación de añadido al carrito -->
	<div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header bg-success text-white">
					<h5 class="modal-title" id="addToCartModalLabel">
						<i class="fas fa-check-circle"></i> ¡Producto agregado!
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body text-center">
					<i class="fas fa-shopping-cart fa-3x text-success mb-3"></i>
					<h5 id="productAddedName">Producto</h5>
					<p class="text-muted">Se ha añadido al carrito de compras exitosamente</p>
				</div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						<i class="fas fa-arrow-left"></i> Seguir comprando
					</button>
					<a href="/web/cart" class="btn btn-primary">
						<i class="fas fa-shopping-cart"></i> Ver carrito
					</a>
				</div>
			</div>
		</div>
	</div>

	<!-- Scripts con fragmento -->
	<div th:replace="~{fragments/login-modal :: loginModal}"></div>
	<div th:replace="~{fragments/register-modal :: registerModal}"></div>
	<div th:replace="~{fragments/scripts :: scripts(${['/js/products.js']})}"></div>
</body>

</html>