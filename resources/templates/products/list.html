<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head('Productos', '/css/products.css', '/js/products.js')}"></head>
<style>
	.product-card {
		transition: transform 0.2s;
		height: 100%;
	}

	.product-card:hover {
		transform: translateY(-5px);
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
	}

	.category-filter {
		max-height: 400px;
		overflow-y: auto;
	}

	.product-image {
		height: 200px;
		object-fit: cover;
	}

	.price {
		font-size: 1.25rem;
		font-weight: bold;
		color: #28a745;
	}

	.original-price {
		text-decoration: line-through;
		color: #6c757d;
		font-size: 0.9rem;
	}
</style>
</head>

<body>
	<!-- Navbar -->
	<div
		th:replace="~{fragments/navbar :: navbar('products', ${categories}, ${cartCount}, ${isAuthenticated}, ${username})}">
	</div>

	<div class="container-fluid mt-4">
		<div class="row">
			<!-- Sidebar con filtros -->
			<div class="col-md-3">
				<div class="card">
					<div class="card-header">
						<h5><i class="fas fa-filter"></i> Filtros</h5>
					</div>
					<div class="card-body">
						<!-- Búsqueda -->
						<form method="get" th:action="@{/web/products}" id="filterForm">
							<div class="mb-3">
								<label for="search" class="form-label">
									<i class="fas fa-search"></i> Buscar productos
								</label>
								<input type="text" class="form-control" id="search" name="search" th:value="${searchTerm}"
									placeholder="Nombre del producto..." />
							</div>

							<!-- Filtro por categorías -->
							<div class="mb-3">
								<label class="form-label"> <i class="fas fa-tags"></i> Categorías </label>
								<div class="category-filter">
									<div class="form-check">
										<input class="form-check-input" type="radio" name="categoryId" id="allCategories" value=""
											th:checked="${selectedCategoryId == null}" />
										<label class="form-check-label" for="allCategories">
											<strong>Todas las categorías</strong>
										</label>
									</div>
									<hr />
									<div class="form-check" th:each="category : ${categories}">
										<input class="form-check-input" type="radio" name="categoryId"
											th:id="'category' + ${category.id}" th:value="${category.id}"
											th:checked="${selectedCategoryId == category.id}" />
										<label class="form-check-label" th:for="'category' + ${category.id}"
											th:text="${category.name}">
										</label>
									</div>
								</div>
							</div>

							<button type="submit" class="btn btn-primary w-100">
								<i class="fas fa-search"></i> Filtrar
							</button>
							<a th:href="@{/web/products}" class="btn btn-outline-secondary w-100 mt-2">
								<i class="fas fa-times"></i> Limpiar filtros
							</a>
						</form>
					</div>
				</div>
			</div>

			<!-- Contenido principal -->
			<div class="col-md-9">
				<!-- Header con información -->
				<div class="d-flex justify-content-between align-items-center mb-4">
					<div>
						<h2>
							<i class="fas fa-box-open"></i>
							<span th:if="${selectedCategoryId != null and categories != null}">
								<span th:each="cat : ${categories}" th:if="${cat.id == selectedCategoryId}"
									th:text="${cat.name}"></span>
							</span>
							<span th:if="${selectedCategoryId == null}">Todos los productos</span>
						</h2>
						<p class="text-muted mb-0">
							<span th:text="${totalElements}">0</span> productos encontrados
							<span th:if="${searchTerm != null and !searchTerm.isEmpty()}">
								para "<strong th:text="${searchTerm}"></strong>"
							</span>
						</p>
					</div>

					<!-- Selector de cantidad por página -->
					<div class="dropdown">
						<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
							<i class="fas fa-list"></i> <span th:text="${pageSize}">12</span> por página
						</button>
						<ul class="dropdown-menu">
							<li>
								<a class="dropdown-item"
									th:href="@{/web/products(page=${currentPage}, size=6, categoryId=${categoryParam}, search=${searchParam})}">6
									por página</a>
							</li>
							<li>
								<a class="dropdown-item"
									th:href="@{/web/products(page=${currentPage}, size=12, categoryId=${categoryParam}, search=${searchParam})}">12
									por página</a>
							</li>
							<li>
								<a class="dropdown-item"
									th:href="@{/web/products(page=${currentPage}, size=24, categoryId=${categoryParam}, search=${searchParam})}">24
									por página</a>
							</li>
						</ul>
					</div>
				</div>

				<!-- Grid de productos -->
				<div class="row" th:if="${products != null and products.hasContent()}">
					<div class="col-md-4 col-lg-3 mb-4" th:each="product : ${products.content}">
						<div class="card product-card h-100">
							<!-- Imagen del producto -->
							<div class="position-relative">
								<img
									th:src="${product.detailProduct?.imageUrl != null ? product.detailProduct.imageUrl : '/images/no-image.png'}"
									class="card-img-top product-image" th:alt="${product.name}" />

								<!-- Badge de condición -->
								<span class="badge position-absolute top-0 start-0 m-2"
									th:classappend="${product.productCondition.name() == 'NEW'} ? 'bg-success' : 
                                                     (${product.productCondition.name() == 'LIKE_NEW'} ? 'bg-info' : 
                                                     (${product.productCondition.name() == 'REFURBISHED'} ? 'bg-warning' : 'bg-secondary'))"
									th:text="${product.productCondition.name() == 'NEW'} ? 'Nuevo' : 
                                               (${product.productCondition.name() == 'LIKE_NEW'} ? 'Como nuevo' : 
                                               (${product.productCondition.name() == 'REFURBISHED'} ? 'Reacondicionado' : 'Usado'))">
								</span>

								<!-- Badge de stock -->
								<span th:if="${product.stock <= 5}" class="badge bg-danger position-absolute top-0 end-0 m-2">
									¡Últimas <span th:text="${product.stock}">5</span>!
								</span>
							</div>

							<div class="card-body d-flex flex-column">
								<!-- Nombre del producto -->
								<h6 class="card-title" th:text="${product.name}">
									Nombre del producto
								</h6>

								<!-- Descripción -->
								<p class="card-text text-muted small flex-grow-1" th:text="${product.detailProduct?.description != null ? 
                                            (product.detailProduct.description.length() > 80 ? 
                                             product.detailProduct.description.substring(0, 80) + '...' : 
                                             product.detailProduct.description) : 'Sin descripción'}"></p>

								<!-- Información adicional -->
								<div class="mb-2">
									<small class="text-muted">
										<i class="fas fa-barcode"></i> Código: <span th:text="${product.code}">123456789</span>
									</small><br />
									<small class="text-muted">
										<i class="fas fa-boxes"></i> Stock: <span th:text="${product.stock}">10</span>
									</small><br />
									<small class="text-muted" th:if="${product.detailProduct?.brand}">
										<i class="fas fa-tag"></i> <span th:text="${product.detailProduct.brand}">Marca</span>
									</small>
								</div>

								<!-- Precio -->
								<div class="mb-3" th:if="${product.detailProduct?.price}">
									<div th:if="${product.detailProduct.discount > 0}">
										<span class="original-price" th:text="'S/. ' + ${product.detailProduct.price}">S/.
											100.00</span>
										<div class="price"
											th:text="'S/. ' + ${product.detailProduct.price * (1 - product.detailProduct.discount / 100.0)}">
											S/. 80.00
										</div>
										<small class="text-success">
											<i class="fas fa-percent"></i> <span
												th:text="${product.detailProduct.discount}">20</span>%
											descuento
										</small>
									</div>
									<div th:if="${product.detailProduct.discount == 0}">
										<div class="price" th:text="'S/. ' + ${product.detailProduct.price}">
											S/. 100.00
										</div>
									</div>
								</div>

								<!-- Botones -->
								<div class="mt-auto">
									<a th:href="@{/web/products/{id}(id=${product.id})}"
										class="btn btn-primary btn-sm w-100 mb-2">
										<i class="fas fa-eye"></i> Ver detalles
									</a>
									<button class="btn btn-outline-success btn-sm w-100" th:if="${product.stock > 0}">
										<i class="fas fa-cart-plus"></i> Agregar al carrito
									</button>
									<button class="btn btn-secondary btn-sm w-100" th:if="${product.stock == 0}" disabled>
										<i class="fas fa-times"></i> Sin stock
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Mensaje cuando no hay productos -->
				<div th:if="${products == null or !products.hasContent()}" class="text-center py-5">
					<i class="fas fa-search fa-3x text-muted mb-3"></i>
					<h4>No se encontraron productos</h4>
					<p class="text-muted">
						<span th:if="${searchTerm != null and !searchTerm.isEmpty()}">
							No hay productos que coincidan con "<strong th:text="${searchTerm}"></strong>"
						</span>
						<span th:if="${searchTerm == null or searchTerm.isEmpty()}">
							No hay productos disponibles en esta categoría
						</span>
					</p>
					<a th:href="@{/web/products}" class="btn btn-primary">
						<i class="fas fa-arrow-left"></i> Ver todos los productos
					</a>
				</div>

				<!-- Paginación -->
				<nav th:if="${products != null and products.hasContent() and totalPages > 1}" class="mt-4">
					<ul class="pagination justify-content-center">
						<!-- Anterior -->
						<li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
							<a class="page-link"
								th:href="@{/web/products(page=${currentPage - 1}, size=${pageSize}, categoryId=${categoryParam}, search=${searchParam})}"
								th:if="${currentPage > 0}">
								<i class="fas fa-chevron-left"></i> Anterior
							</a>
							<span class="page-link" th:if="${currentPage == 0}">
								<i class="fas fa-chevron-left"></i> Anterior
							</span>
						</li>

						<!-- Números de página -->
						<li class="page-item" th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
							th:if="${pageNum >= currentPage - 2 and pageNum <= currentPage + 2}"
							th:classappend="${pageNum == currentPage} ? 'active'">
							<a class="page-link"
								th:href="@{/web/products(page=${pageNum}, size=${pageSize}, categoryId=${categoryParam}, search=${searchParam})}"
								th:text="${pageNum + 1}">1</a>
						</li>

						<!-- Siguiente -->
						<li class="page-item" th:classappend="${currentPage >= totalPages - 1} ? 'disabled'">
							<a class="page-link"
								th:href="@{/web/products(page=${currentPage + 1}, size=${pageSize}, categoryId=${categoryParam}, search=${searchParam})}"
								th:if="${currentPage < totalPages - 1}">
								Siguiente <i class="fas fa-chevron-right"></i>
							</a>
							<span class="page-link" th:if="${currentPage >= totalPages - 1}">
								Siguiente <i class="fas fa-chevron-right"></i>
							</span>
						</li>
					</ul>
				</nav>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		// Auto-submit del formulario cuando cambia la categoría
		document.addEventListener('DOMContentLoaded', function () {
			const categoryInputs = document.querySelectorAll('input[name="categoryId"]');
			categoryInputs.forEach((input) => {
				input.addEventListener('change', function () {
					document.getElementById('filterForm').submit();
				});
			});

			// Búsqueda en tiempo real (opcional)
			const searchInput = document.getElementById('search');
			let searchTimeout;
			searchInput.addEventListener('input', function () {
				clearTimeout(searchTimeout);
				searchTimeout = setTimeout(() => {
					if (this.value.length >= 3 || this.value.length === 0) {
						document.getElementById('filterForm').submit();
					}
				}, 500);
			});
		});
	</script>

	<!-- Scripts -->
	<div th:replace="~{fragments/scripts :: scripts('/js/products.js')}"></div>
</body>

</html>